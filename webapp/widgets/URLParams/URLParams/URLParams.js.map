{"version":3,"sources":["../../../../widgets/URLParams/URLParams/URLParams.js"],"names":["_WidgetBase","declare","hash","ioQuery","Point","Query","topic","map","config","constructor","window","URLParams","inherited","arguments","postCreate","console","log","initializeRouter","params","queryToObject","guid","layerid","layer","getLayer","query","returnGeometry","where","selectFeatures","then","features","length","feature","fields","displayField","layerID","id","project","geometry","type","centerAndZoom","pointZoomLevel","setExtent","getExtent","wireEvents","scale","x","y","setScale","parseInt","centerAt","spatialReference","wkid","bind","clickx","clicky","clickpoint","infopanel","basemap","modes","phaseIndexes","own","on","onMapExtentChange","subscribe","setProjectParams","removeParams","setParams","setClickParams","setBaseMap","setFilterParams","filterParams","mapPoint","event","center","extent","getCenter","Math","round","getScale","newParams","Object","assign","objectToQuery","forEach","param"],"mappings":"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","sourcesContent":["import _WidgetBase from 'dijit/_WidgetBase';\nimport declare from 'dojo/_base/declare';\nimport hash from 'dojo/hash';\nimport ioQuery from 'dojo/io-query';\nimport Point from 'esri/geometry/Point';\nimport Query from 'esri/tasks/query';\nimport topic from 'dojo/topic';\n\n\nexport default declare([_WidgetBase], {\n  // properties passed in via constructor\n  // map: esri/map\n  map: null,\n\n  // config: Object\n  config: null,\n\n  constructor(/* props */) {\n    window.URLParams = {};\n\n    this.inherited(arguments);\n  },\n\n  postCreate() {\n    console.log('URLParams:postCreate', arguments);\n\n    this.initializeRouter();\n\n    this.inherited(arguments);\n  },\n\n  initializeRouter() {\n    console.log('URLParams:initializeRouter', arguments);\n\n    const params = ioQuery.queryToObject(hash());\n\n    if (params.guid && params.layerid) {\n      const layer = this.map.getLayer(params.layerid);\n\n      const query = new Query();\n      query.returnGeometry = true;\n      query.where = `GlobalID = '${params.guid}'`;\n\n      layer.selectFeatures(query).then(features => {\n        if (features.length > 0) {\n          const feature = features[0];\n          feature.fields = layer.fields;\n          feature.displayField = layer.displayField;\n          feature.layerID = layer.id;\n\n          // to be picked up by ProjectInfo widget\n          window.URLParams.project = feature;\n\n          if (feature.geometry.type === 'point') {\n            this.map.centerAndZoom(feature.geometry, this.config.pointZoomLevel);\n          } else {\n            this.map.setExtent(feature.geometry.getExtent(), true);\n          }\n        }\n\n        this.wireEvents();\n      });\n    } else if (params.scale && params.x && params.y) {\n      this.map.setScale(parseInt(params.scale, 10));\n      this.map.centerAt(new Point({\n        x: parseInt(params.x, 10),\n        y: parseInt(params.y, 10),\n        spatialReference: { wkid: this.map.spatialReference.wkid }\n      })).then(this.wireEvents.bind(this));\n    } else {\n      this.wireEvents();\n    }\n\n    if (params.clickx && params.clicky) {\n      // to be picked up by ProjectInfo\n      window.URLParams.clickpoint = {\n        x: params.clickx,\n        y: params.clicky\n      };\n    }\n\n    if (params.infopanel) {\n      // to be picked up by BetterAbout\n      window.URLParams.infopanel = params.infopanel;\n    }\n\n    if (params.basemap) {\n      // to be picked up by LayerSelector\n      window.URLParams.basemap = params.basemap;\n    }\n\n    // both of these to be picked up by WFRCFilter\n    if (params.modes) {\n      window.URLParams.modes = (typeof params.modes === 'string') ? [params.modes] : params.modes;\n    }\n    if (params.phaseIndexes) {\n      window.URLParams.phaseIndexes = params.phaseIndexes;\n    }\n  },\n\n  wireEvents() {\n    console.log('URLParams:wireEvents', arguments);\n\n    this.own(\n      this.map.on('extent-change', this.onMapExtentChange.bind(this)),\n      topic.subscribe('url-params-on-project-click', this.setProjectParams.bind(this)),\n      this.map.on('click', this.removeParams.bind(this, ['guid', 'layerid'])),\n      topic.subscribe('url-params-on-infopanel-open', this.setParams.bind(this, { infopanel: 'open' })),\n      topic.subscribe('url-params-on-infopanel-close', this.setParams.bind(this, { infopanel: 'closed' })),\n      topic.subscribe('url-params-on-map-click', this.setClickParams.bind(this)),\n      topic.subscribe('url-params-on-layer-selector-change', this.setBaseMap.bind(this)),\n      topic.subscribe('url-params-on-filter-change', this.setFilterParams.bind(this))\n    );\n  },\n\n  setFilterParams(filterParams) {\n    console.log('URLParams:setFilterParams', arguments);\n\n    this.setParams({\n      ...filterParams\n    });\n  },\n\n  setBaseMap(basemap) {\n    console.log('URLParams:setBaseMap', arguments);\n\n    this.setParams({ basemap });\n  },\n\n  setClickParams(mapPoint) {\n    console.log('URLParams:setClickParams');\n\n    this.setParams({\n      clickx: mapPoint.x,\n      clicky: mapPoint.y\n    });\n  },\n\n  onMapExtentChange(event) {\n    console.log('URLParams:onMapExtentChange', arguments);\n\n    const center = event.extent.getCenter();\n    if (center.x && center.y) {\n      this.setParams({\n        x: Math.round(center.x),\n        y: Math.round(center.y),\n        scale: Math.round(this.map.getScale())\n      });\n    }\n  },\n\n  setProjectParams(config) {\n    // config contains url and guid\n    console.log('URLParams:setProjectParams', arguments);\n\n    this.setParams(config);\n    this.removeParams(['x', 'y', 'scale', 'clickx', 'clicky']);\n  },\n\n  setParams(params) {\n    // sets the params in the URL without messing with other ones\n    console.log('URLParams:setParams');\n\n    const newParams = Object.assign(ioQuery.queryToObject(hash()), params);\n\n    return hash(ioQuery.objectToQuery(newParams), true);\n  },\n\n  removeParams(params) {\n    // params: string[]\n    console.log('URLParams:removeParams', arguments);\n\n    const newParams = ioQuery.queryToObject(hash());\n\n    params.forEach(param => delete newParams[param]);\n\n    return hash(ioQuery.objectToQuery(newParams), true);\n  }\n});\n"],"file":"URLParams.js"}